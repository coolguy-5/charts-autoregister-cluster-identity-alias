suite: test sdm-proxy post-install conditions
templates:
  - post-install.yaml
tests:
  # Basic RBAC without identity aliases
  - it: should not be any CLI command if auto register is not used.
    set:
      strongdm.auth.clusterKey: "test-key"
      strongdm.auth.clusterSecret: "test-secret"
      strongdm.autoRegisterCluster.enabled: false
      strongdm.autoRegisterCluster.identitySetName: "test-identity-set"
      strongdm.healthcheckUsername: "test-healthcheck-user"
    asserts:
        - hasDocuments:
            count: 0
  
  - it: should not require a discoveryUsername with identity aliases are used.
    set:
      strongdm.auth.clusterKey: "test-key"
      strongdm.auth.clusterSecret: "test-secret"
      strongdm.auth.adminToken: "test-token"
      strongdm.autoRegisterCluster.enabled: true
      strongdm.autoRegisterCluster.identitySetName: "test-identity-set"
      strongdm.healthcheckUsername: "test-healthcheck-user"
    asserts:
        - hasDocuments:
            count: 1
